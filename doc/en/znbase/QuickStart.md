# QuickStart

## Quick Deploy

**This chapter only describes how to quickly start ZNBase in insecure mode, and how to use Ansible to quickly deploy a ZNBase cluster in secure mode.**



Firstly, you should download the binary executable file of **ZNBase** ([ZNBase Download Address]()), and then store it in any path of the machine you want to deploy. After entering this directory, do the following operations.



**Note: For production environments, you must refer to the Installation and Deployment section for actual deployment!**

### Insecure-Mode start: 

#### A. Start the cluster service

```sh
bini start --insecure [--store=<Data Directory>] [--advertise-addr=<Node Address>:<Node Port>] --listen-addr=<Node Address>:<Node Port>--http-addr=<Node Address>:<Node HTTP Port> --join=<Node List of Cluster> [--cache=<Percent or Actual Usage Size of Physical Memory>] [--max-sql-memory=<Percent or Actual Usage Size of Memory>] --background
```

#### **B. Initialize the database**

```sh
bini init --insecure --host=<Address and Port of any Node>
```
#### **C. Login to database**

```sh
bini sql --insecure --host=<Address and Port of any Node>
```
**Notice：**

1、`<Node List of Cluster>:=<Node1 Address>[:<Node1 Port>,][…]` . This represents the node list of the cluster.

2、`<Node Port>` is the service port of the node, the default is `26257`, which can be omitted when using the default value.

3、`<Node HTTP Port>` is the HTTP service port of the node. Default is `8080`, which can be omitted when using the default value.

4、`<Percent or Actual Usage Size of Physical Memory>` represents the amount of memory allocated for this parameter, either as a percentage of a decimal, or as a fixed number in MB, GB, and so on.

5、When the `--store` parameter is not specified, a data store directory is generated by default, which now is *`'bini-data'`*.

6、When you do not specify `--advertise-addr`, the default value is `--listen-addr`

### **The deployment of Ansible：**

About how to download, install and use Ansible, please refer to [Ansible's official documentation](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html).

#### **1. Conditions of use**

Ansible has been installed on the execution node and SSH trust between the execution node and the NewSQL nodes has been configured.

#### **2. The description of Configuration file `param.yaml` parameter **

```yaml
 server_port: 26257  ----NewSQL service port
 monitor_port: 8080  ----NewSQL monitor web page port
 store_path: /opt/node_data  ----NewSQL storage path
 cache: .25  ----NewSQL cache Size，'.25' represents '25%'
 max_sql_memory: .1  ----The temporary SQL cache size for NewSQL, '.1' represents '10%'
 certs_dir: /root/certs  ----The storage path of user certificate file  (for client connection)
 make_certs_dir: /opt/certs  ----the certificate file storage path
 make_ca_keys_dir: /opt/my-safe-directory  ----CA秘钥文件存放路径
 db_admin: bini  ----Database user name with admin permissions
 db_password: 123456  ----The password for the database user 'db_admin' 
 ntpserver: 0.cn.pool.ntp.org  ----NTP Server IP
```

 

#### **3. Usage**

（1）Add group **BINI_SETUP** to Ansible's host file. Within the group, configure the node information of deploying **bini** form of IP

![img](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\Pictures\3-1.png)
 （2）Place the binary files of **`bini`** in the same directory as **`playbook`** files

![img](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\3-2.png)
 （3）Modify the Settings in **`param.yaml`**

![img](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\3-3.png)
 （4）Execute this command `ansible-playbook bini_secure.playbook -e "@param.yaml"` to set up **bini**

![img](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\3-4-1.png)

![img](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\3-4-2.png)![img](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\3-4-3.png)

（5）Check the status of NewSQL cluster nodes

Login to the first node in the configuration file `/etc/ansible/hosts`，and execute the following command：

```sh
bini node status --certs-dir=/root/certs/ --host=< IP Address of Node1 >:< Service Port of Node1 >
```

**Notice：**`< IP Address of Node1 >` represents the IP address of the first node，`< Service Port of Node1 >` represents the service port number of the first node.

![img](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\3-5.png)

（6）Check the status of NewSQL nodes background process on the node which Ansible  runs

```sh
ansible bini_setup -m shell -a "ps -ef |grep bini |grep -vi grep"
```

 ![3-6](C:\Users\wudi03\Desktop\关于ZNBase和快速入门\3-6.png)

## ****Basic Operation**

After deploying the ZNBase cluster successfully , SQL statements can be executed in ZNBase. This document covers basic SQL operations. For complete SQL syntax rules, please refer to [ZNBase SQL Language Reference]().

### 1）Create a database

```mysql
\> CREATE DATABASE testdb;
```

### 2）create a new user 'test'

```mysql
#Password authentication cannot be used in insecure mode, so you cannot set a password for a new user

\> CREATE USER test;
```



### 3）Grants all permissions on the database 'testdb' and on the schema 'public'  to 'test' 

```mysql
\> GRANT ALL ON DATABASE testdb TO test;

\> GRANT ALL ON SCHEMA testdb.public TO test;
```

### 4) Use  the user  ‘test’ to connect to the database 'testdb'

```sh
bini sql --insecure --host=test1:26300 -u test -d testdb
```

### 5) Create the table 't1' in the default schema 'public'

```
\> CREATE TABLE t1(id INT PRIMARY KEY,amount DECIMAL(32,2) NOT NULL,from_account STRING(100) NOT NULL,to_account STRING(100) NOT NULL,create_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP());
```



### 6) Initialize the data and perform DML operations like INSERT,DELETE,UPDATE,and QUERY.

```
\> INSERT INTO t1 (id,amount,from_account,to_account) VALUES(1,10000.01,'Jack','Tom'),(2,500.89,'Jack','Tom'),(3,3000.1,'Jack','Tom'),

(4,600000,'Tom','Bob'),(5,30000,'Jack','Allen'),(6,1000000,'Bob','Jack'),(7,1000,'Bob','Tom'),(8,999.99,'Allen','Bob'),(9,666.13,'Allen','Tom'),(10,88888,'Jack','Tom');

\> SELECT * FROM t1;

 id |  amount  | from_account | to_account |    create_timestamp      

+----+------------+--------------+------------+---------------------------------+

  1 |  10000.01 | Jack     | Tom    | 2020-11-13 10:01:12.52328+00:00 

  2 |   500.89 | Jack     | Tom    | 2020-11-13 10:01:12.52328+00:00 

  3 |  3000.10 | Jack     | Tom    | 2020-11-13 10:01:12.52328+00:00 

  4 | 600000.00 | Tom     | Bob    | 2020-11-13 10:01:12.52328+00:00 

  5 |  30000.00 | Jack     | Allen   | 2020-11-13 10:01:12.52328+00:00 

  6 | 1000000.00 | Bob     | Jack    | 2020-11-13 10:01:12.52328+00:00 

  7 |  1000.00 | Bob     | Tom    | 2020-11-13 10:01:12.52328+00:00 

  8 |   999.99 | Allen    | Bob    | 2020-11-13 10:01:12.52328+00:00 

  9 |   666.13 | Allen    | Tom    | 2020-11-13 10:01:12.52328+00:00 

 10 |  88888.00 | Jack     | Tom    | 2020-11-13 10:01:12.52328+00:00 

(10 rows)

 

Time: 3.011334ms

\> SELECT * FROM t1 LIMIT 1;

 id | amount | from_account | to_account |    create_timestamp     

+----+----------+--------------+------------+---------------------------------+

  1 | 10000.01 | Jack     | Tom    | 2020-11-13 10:01:12.52328+00:00 

(1 row)

 

Time: 986.941µs

\>INSERT INTO t1(id,amount,from_account,to_account) VALUES(11,4800,'Carl','Mike'),(12,3300,'Carl','James'),(13,900,'Diego','Carl');

INSERT 3

 

Time: 5.402443ms

 

\> UPDATE t1 SET amount = 33000 WHERE id = 12;

DELETE FROM t1 WHERE id = 13;

UPDATE 1

 

Time: 23.905949ms

 

\> DELETE FROM t1 WHERE id = 13;

DELETE 1

 

Time: 6.483638ms

 

\> SELECT * FROM t1 WHERE id > 10;

 id | amount | from_account | to_account |     create_timestamp     

+----+----------+--------------+------------+----------------------------------+

 11 | 4800.00 | Carl     | Mike    | 2020-11-13 10:03:46.200896+00:00 

 12 | 33000.00 | Carl     | James   | 2020-11-13 10:03:46.200896+00:00 

(2 rows)

--Paging Query

Time: 1.132672ms

\>SELECT * FROM t1 WHERE id > 10 LIMIT 1;

 id | amount | from_account | to_account |     create_timestamp     

+----+---------+--------------+------------+----------------------------------+

 11 | 4800.00 | Carl     | Mike    | 2020-11-27 10:05:49.914003+00:00 

(1 row)

 

Time: 1.333644ms

 

\>SELECT * FROM t1 WHERE id > 10 LIMIT 1 OFFSET 1;

 id | amount | from_account | to_account |     create_timestamp     

+----+----------+--------------+------------+----------------------------------+

 12 | 33000.00 | Carl     | James   | 2020-11-27 10:05:49.914003+00:00 

(1 row)

 

Time: 782.286µs

 

\>SELECT * FROM t1 WHERE id > 10 FETCH FIRST 1 ROW ONLY;

 id | amount | from_account | to_account |     create_timestamp     

+----+---------+--------------+------------+----------------------------------+

 11 | 4800.00 | Carl     | Mike    | 2020-11-27 10:05:49.914003+00:00 

(1 row)

 

Time: 950.55µs

 

\> SELECT * FROM t1 WHERE id > 10 OFFSET 1 FETCH NEXT 1 ROW ONLY;

 id | amount | from_account | to_account |     create_timestamp     

+----+----------+--------------+------------+----------------------------------+

 12 | 33000.00 | Carl     | James   | 2020-11-27 10:05:49.914003+00:00 

(1 row)

 

Time: 921.126µs

--Aggregate Functions and Analytic Functions

\>SELECT from_account,SUM(amount) expense FROM t1 GROUP BY from_account order by 1;

 from_account | expense  

+--------------+------------+

 Allen    |  1666.12 

 Bob     | 1001000.00 

 Carl     |  37800.00 

 Jack     | 132389.00 

 Tom     | 600000.00 

(5 rows)

 

Time: 1.76955ms

 

\>SELECT from_account,SUM(amount) OVER(PARTITION BY from_account) total_expense,

ROW_NUMBER() OVER(PARTITION BY from_account ORDER BY create_timestamp,to_account) rn,amount,to_account FROM t1;

 from_account | total_expense | rn |  amount  | to_account 

+--------------+---------------+----+------------+------------+

 Allen    |    1666.12 | 1 |   999.99 | Bob     

 Allen    |    1666.12 | 2 |   666.13 | Tom     

 Bob     |  1001000.00 | 2 |  1000.00 | Tom     

 Bob     |  1001000.00 | 1 | 1000000.00 | Jack    

 Carl     |   37800.00 | 2 |  4800.00 | Mike    

 Carl     |   37800.00 | 1 |  33000.00 | James    

 Jack     |   132389.00 | 2 |  88888.00 | Tom     

 Jack     |   132389.00 | 3 |  10000.01 | Tom     

 Jack     |   132389.00 | 4 |   500.89 | Tom     

 Jack     |   132389.00 | 5 |  3000.10 | Tom     

 Jack     |   132389.00 | 1 |  30000.00 | Allen    

 Tom     |   600000.00 | 1 | 600000.00 | Bob     

(12 rows)

 

Time: 1.212536ms

--Common Table Expression (CTE),Views and Multiple Table Query

\>WITH u AS (SELECT DISTINCT from_account account FROM t1 UNION SELECT DISTINCT to_account FROM t1)

SELECT u.account, IFNULL(b.income,0) income, IFNULL(a.expense,0) expense,IFNULL(b.income,0)-IFNULL(a.expense,0) net_income FROM u 

LEFT JOIN (SELECT from_account,SUM(amount) expense FROM t1 GROUP BY from_account) a ON u.account = a.from_account

LEFT JOIN (SELECT to_account,SUM(amount) income FROM t1 GROUP BY to_account) b ON u.account = b.to_account;

 account |  income  | expense  | net_income 

+---------+------------+------------+------------+

 Carl  |     0 |  37800.00 | -37800.00 

 Jack  | 1000000.00 | 132389.00 | 867611.00 

 Tom   | 104055.13 | 600000.00 | -495944.87 

 Bob   | 600999.99 | 1001000.00 | -400000.01 

 Allen  |  30000.00 |  1666.12 |  28333.88 

 Mike  |  4800.00 |     0 |  4800.00 

 James  |  33000.00 |     0 |  33000.00 

(7 rows)

 

Time: 2.458159ms
```